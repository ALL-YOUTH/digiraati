<!doctype html>
<html>
  <head>
    <title>Lakiteksti kommentointi</title>
    <link href="../css/style.css" rel="stylesheet" type="text/css">
    <meta charset="UTF-8">
  </head>
  <body>
    <div class="row" id="navbar">
        <span>
          <button onclick="home()" id="home">Home</button>
          <button onclick="profile()" id="profile">My Profile</button>
          <button id="exit" style="float:right">Exit</button>
        </span>
    </div>
    <div class="row">
      <div style="border-style:solid; width:10%; float:left">
        <ul id="lakilista" style="list-style-type:circle;">
          <li id="/2015/609">Ilmastolaki</li>
          <li id="/1987/990">Ydinenergialaki</li>
          <li id="/1998/628">Perusopetuslaki</li>
          <li id="/1995/1774">Eläkesäätiölaki</li>
        </ul>
      </div>
      <div id="lakiteksti_container" style="border-style:solid; width:60%; float:left;">
        <div id="lakiteksti_title">
          <h2>Lakiteksti</h2>
        </div>
        <div id="lakiteksti" style="margin:5px;">
        </div>
      </div>
      <div id="comment_container" style="border-style:solid; width:29%; float:left;">
        <div id="comment_title">
          <h2>Kommentit</h2>
        </div>
      </div>
    </div>
    <div id='rclickmenu'>
      <div id="comment_quote">
      </div>
      <input id="comment_text" type="text" style="resize:both;"></input>
      <hr>
      <ul>
        <li id='options' onclick="comment()">Lisää Kommentti</li>
        <hr>
        <li id='options' onclick="cancel_comment()">Peru</li>
      </ul>
    </div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var lawList = document.querySelectorAll("#lakilista li"); // this returns an array of each li
      var finlex_base = "http://data.finlex.fi/eli/sd";
      var headers = {"Accept":"application/ld+json"};
      var num_comments = 0;
      var current_comment = "";

      lawList.forEach(function(item) {
        item.onclick = function(e) {
          display_text(this.id); // this returns clicked li's value
        }
      });

      function display_text(id){
        text = get_text(id);
        document.getElementById("lakiteksti").innerHTML = text;

      }
      function get_text(id){
        url = finlex_base + id;
        var r = new XMLHttpRequest();
        r.open( "GET", url, false );
        r.setRequestHeader("Accept", "application/ld+json");
        r.send( null );
        var data = JSON.parse(r["response"]);
        return data["temporalVersion"]["languageVersion"]["hasFormat"]["content_fi"];
      }

      function getSelectionText() {
        var text = "";
        if (window.getSelection) {
          text = window.getSelection().toString();
        }
          return text;
      }

      $("#lakiteksti_container").mouseup(function(e){
        console.log("Now check the selection");
        selected_text = getSelectionText();
        console.log(e);
        if(selected_text.length == 0){
          hide_context_menu();
          return;
        }
        else {
          open_context_menu(e);
        }
      });

      function open_context_menu(e){
        var rclickmenu = document.getElementById("rclickmenu");
        var quote = getSelectionText();
        document.getElementById("comment_quote").innerHTML = "\"" + quote + "\"";
        current_comment = quote;
        rclickmenu.style.left = e.pageX +"px";
        rclickmenu.style.top = e.pageY +"px";
        rclickmenu.style.display = "block";
      }

      function hide_context_menu(e){
        document.getElementById("rclickmenu").style.display = "none";
      }

      function startFocusOut(){
        $("#cancel_comment").on("click",function(){
          $("#rclickmenu").hide();
          $(document).off("click");
        });
      }

      function comment(){
        console.log("Adding a new comment");
        comment_text = document.getElementById("comment_text").value;
        var new_comment = document.createElement("a");
        new_comment.classList.add("comment");
        new_comment.innerHTML = comment_text;
        new_comment.id = "comment-" + num_comments;
        new_comment.value = current_comment;
        new_comment.onmouseover = function(){bold_commented(this)};
        new_comment.onmouseout = function(){unbold_commented(this)};
        comment_list = document.getElementById("comment_container");
        //TODO tee lisää juttuja että kommentit näyttää siistimmiltä
        comment_list.appendChild(new_comment);
        document.getElementById('rclickmenu').style.display = "none";
        comment_list.appendChild(document.createElement("br"));
        ++num_comments;
      }

      function cancel_comment(){
        console.log("cancelling comment");
        document.getElementById('rclickmenu').style.display = "none";
      }

      function bold_commented(e){
        var text_element = document.getElementById("lakiteksti");
        text = text_element.innerHTML;
        var i = text.indexOf(e.value);
        console.log(text.indexOf(e.value));
        console.log(e.value);
        if(i > -1){
          var text_length = e.value.length;
          var temp_text = text.substr(0, i) + "<b>";
          temp_text = temp_text + text.substr(i, text_length);
          temp_text = temp_text + "</b>" + text.substr(text_length + i);
          text_element.innerHTML = temp_text;
        }
      }

      function unbold_commented(e){
        console.log("unbolding comment");
        var text_element = document.getElementById("lakiteksti");
        var temp_text = text_element.innerHTML;
        text_element.innerHTML = temp_text;
      }
    </script>

  </body>
</html>
